<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.6.2">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Guillaume Dueymes">

  
  
  
    
  
  <meta name="description" content="Netcdf: Interpolation between grids using cKDTree from Scipy library and correlation In this post, we will interpolate a nectcdf file to another netcdf grid and then calculate timeseries spearman correlation between two datasets on same resolution grid.
To interpolate, we will follow this post
In this example, we will interpolate Daymet-1km dataset on ERA5-grid.
We will compute monthly total precipipitation and then compare the two datasets using spearman correlation.
The Daymet dataset provides gridded estimates of daily weather parameters.">

  
  <link rel="alternate" hreflang="en-us" href="/post/spearman/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/post/spearman/">

  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="GDueymes">
  <meta property="og:url" content="/post/spearman/">
  <meta property="og:title" content="Spearman correlation between two Netcdf datasets | GDueymes">
  <meta property="og:description" content="Netcdf: Interpolation between grids using cKDTree from Scipy library and correlation In this post, we will interpolate a nectcdf file to another netcdf grid and then calculate timeseries spearman correlation between two datasets on same resolution grid.
To interpolate, we will follow this post
In this example, we will interpolate Daymet-1km dataset on ERA5-grid.
We will compute monthly total precipipitation and then compare the two datasets using spearman correlation.
The Daymet dataset provides gridded estimates of daily weather parameters."><meta property="og:image" content="/post/spearman/featured.png">
  <meta property="twitter:image" content="/post/spearman/featured.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-04-24T12:03:32-07:00">
    
    <meta property="article:modified_time" content="2020-04-24T12:03:32-07:00">
  

  


    






  






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/spearman/"
  },
  "headline": "Spearman correlation between two Netcdf datasets",
  
  "image": [
    "/post/spearman/featured.png"
  ],
  
  "datePublished": "2020-04-24T12:03:32-07:00",
  "dateModified": "2020-04-24T12:03:32-07:00",
  
  "author": {
    "@type": "Person",
    "name": "Guillaume Dueymes"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "GDueymes",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/icon-512.png"
    }
  },
  "description": "Netcdf: Interpolation between grids using cKDTree from Scipy library and correlation In this post, we will interpolate a nectcdf file to another netcdf grid and then calculate timeseries spearman correlation between two datasets on same resolution grid.\nTo interpolate, we will follow this post\nIn this example, we will interpolate Daymet-1km dataset on ERA5-grid.\nWe will compute monthly total precipipitation and then compare the two datasets using spearman correlation.\nThe Daymet dataset provides gridded estimates of daily weather parameters."
}
</script>

  

  


  


  





  <title>Spearman correlation between two Netcdf datasets | GDueymes</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    
    
      <a class="navbar-brand" href="/">GDueymes</a>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/courses/"><span>Courses</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/Guillaume_Dueymes2019.pdf"><span>CV</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item">
        <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Spearman correlation between two Netcdf datasets</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Apr 24, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    6 min read
  </span>
  

  
  
  

  
  

</div>

  














</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 529px;">
  <div style="position: relative">
    <img src="/post/spearman/featured_hud47bbdd778e24d10ae92f1909d906160_163835_720x0_resize_lanczos_2.png" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <h2 id="netcdf-interpolation-between-grids-using-ckdtree-from-scipy-library-and-correlation">Netcdf: Interpolation between grids using cKDTree from Scipy library and correlation</h2>
<p>In this post, we will interpolate a nectcdf file to another netcdf grid and then calculate timeseries spearman correlation between two datasets on same resolution grid.</p>
<p>To interpolate, we will follow this <a href="https://www.guillaumedueymes.com/post/netcdf_interpolation/">post</a></p>
<p>In this example, we will interpolate <a href="https://daymet.ornl.gov/">Daymet-1km dataset</a> on <a href="https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5">ERA5-grid</a>.</p>
<p>We will compute monthly total precipipitation and then compare the two datasets using spearman correlation.</p>
<p>The Daymet dataset provides gridded estimates of daily weather parameters. Seven surface weather parameters are available at a daily time step, 1 km x 1 km spatial resolution, with a North American spatial extent.</p>
<p>ERA5 Reanalyses provide a numerical description, with horizontal resolution of 31 km, of the recent climate (1979-present) by combining models with observations.</p>
<h3 id="1--lets-import-python-librairies">1-  Let's import Python librairies</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> warnings; warnings<span style="color:#f92672">.</span>filterwarnings(action<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ignore</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">%</span>matplotlib inline
<span style="color:#75715e">#for Netcdf manipulation</span>
<span style="color:#f92672">import</span> xarray <span style="color:#f92672">as</span> xr
<span style="color:#f92672">from</span> netCDF4 <span style="color:#f92672">import</span> Dataset
<span style="color:#f92672">import</span> netCDF4 <span style="color:#f92672">as</span> nc

<span style="color:#75715e">#for array manipulation</span>
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

<span style="color:#75715e">#for plotting</span>
<span style="color:#f92672">import</span> cartopy.crs <span style="color:#f92672">as</span> ccrs
<span style="color:#f92672">import</span> cartopy.feature <span style="color:#f92672">as</span> cfeature
<span style="color:#f92672">import</span> matplotlib.pylab <span style="color:#f92672">as</span> plt

<span style="color:#75715e">#for interpolation</span>
<span style="color:#f92672">from</span> scipy.spatial <span style="color:#f92672">import</span> cKDTree
</code></pre></div><h4 id="we-will-only-work-over-july-month-from-1980-to-2019">We will only work over july month from 1980 to 2019:</h4>
<h3 id="2--interpolation--daymet1km-to-daymet32km-era5-grid">2 - Interpolation : Daymet-1km to Daymet-32km (ERA5 grid)</h3>
<p>We are going to use daily precipitation of Daymet-1km for july. In this analysis, we will use a subset of Daymet-1km and ERA5-32km. Indeed, we will only work over a specific watershed in Canada: Outaouais river's watershed:</p>
<p><img src="attachment:image.png" alt="watershed.png"></p>
<p>Here's the script to interpolate:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">path_source <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">K:/PROJETS/PROJET_OUTAOUAIS/Daily/prcp/</span><span style="color:#e6db74">&#39;</span> <span style="color:#75715e"># path with daily precipitation</span>
<span style="color:#f92672">import</span> gc
gc<span style="color:#f92672">.</span>collect()

variable <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Prcp</span><span style="color:#e6db74">&#39;</span>
yi <span style="color:#f92672">=</span> <span style="color:#ae81ff">1980</span>
yf <span style="color:#f92672">=</span> <span style="color:#ae81ff">2019</span>

<span style="color:#75715e"># Load target grid to interpolate</span>
target <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_dataset(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Outaouais_ERA5_Grid.nc</span><span style="color:#e6db74">&#39;</span>)
lat_target<span style="color:#f92672">=</span>target<span style="color:#f92672">.</span>latitude
lon_target<span style="color:#f92672">=</span>target<span style="color:#f92672">.</span>longitude
lat_target<span style="color:#f92672">.</span>shape

lon_target2d, lat_target2d <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>meshgrid(lon_target, lat_target)

<span style="color:#75715e"># Load source file to create cKDTree </span>
source <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_dataset(path_source <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_prcp_1980_OUTAOUAIS.nc</span><span style="color:#e6db74">&#39;</span>)
lat_source <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>][:]
lon_source <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>][:]

<span style="color:#75715e"># function to convert latlon to xy coordinate system</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lon_lat_to_cartesian</span>(lon, lat):
    <span style="color:#75715e"># WGS 84 reference coordinate system parameters</span>
    A <span style="color:#f92672">=</span> <span style="color:#ae81ff">6378.137</span> <span style="color:#75715e"># major axis [km]   </span>
    E2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6.69437999014e-3</span> <span style="color:#75715e"># eccentricity squared </span>
    
    lon_rad <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>radians(lon)
    lat_rad <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>radians(lat)
    <span style="color:#75715e"># convert to cartesian coordinates</span>
    r_n <span style="color:#f92672">=</span> A <span style="color:#f92672">/</span> (np<span style="color:#f92672">.</span>sqrt(<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> E2 <span style="color:#f92672">*</span> (np<span style="color:#f92672">.</span>sin(lat_rad) <span style="color:#f92672">*</span><span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>)))
    x <span style="color:#f92672">=</span> r_n <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>cos(lat_rad) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>cos(lon_rad)
    y <span style="color:#f92672">=</span> r_n <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>cos(lat_rad) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>sin(lon_rad)
    z <span style="color:#f92672">=</span> r_n <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> E2) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>sin(lat_rad)
    <span style="color:#66d9ef">return</span> x,y,z

xs, ys, zs <span style="color:#f92672">=</span> lon_lat_to_cartesian(lon_source<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>flatten(), lat_source<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>flatten())
xt, yt, zt <span style="color:#f92672">=</span> lon_lat_to_cartesian(lon_target2d<span style="color:#f92672">.</span>flatten(), lat_target2d<span style="color:#f92672">.</span>flatten())

tree <span style="color:#f92672">=</span> cKDTree(np<span style="color:#f92672">.</span>column_stack((xs, ys, zs)))

d, inds <span style="color:#f92672">=</span> tree<span style="color:#f92672">.</span>query(np<span style="color:#f92672">.</span>column_stack((xt, yt, zt)), k <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># let&#39;s define a function to interpolate </span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">interpolate</span>(source, target, d, inds):    
    nt <span style="color:#f92672">=</span> source[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">time</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
    tmp <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, nt):        
        w <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">/</span> d<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
        air_idw <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sum(w <span style="color:#f92672">*</span> source<span style="color:#f92672">.</span>prcp[t]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>flatten()[inds], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> np<span style="color:#f92672">.</span>sum(w, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        air_idw<span style="color:#f92672">.</span>shape <span style="color:#f92672">=</span> target<span style="color:#f92672">.</span>shape
        tmp<span style="color:#f92672">.</span>append(air_idw)
    <span style="color:#66d9ef">return</span> tmp

<span style="color:#75715e"># we will make a loop over years and save netcdf files by month</span>
<span style="color:#66d9ef">for</span> year <span style="color:#f92672">in</span> range(yi,yf<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
    source <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_dataset(path_source <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_prcp_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS.nc</span><span style="color:#e6db74">&#39;</span>)
    air_idw <span style="color:#f92672">=</span> interpolate(source,lon_target2d, d, inds)
    
    data_set <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>Dataset( coords<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>: ([ <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>], lon_target),
                                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>: ([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>,], lat_target),
                                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time</span><span style="color:#e6db74">&#39;</span>: source<span style="color:#f92672">.</span>time<span style="color:#f92672">.</span>values})
    data_set[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">prcp</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> ([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>],  air_idw)
    [data_set<span style="color:#f92672">.</span>sel(time<span style="color:#f92672">=</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">-</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:02d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(i))<span style="color:#f92672">.</span>to_netcdf(path_source <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> variable <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:02d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(i)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_ERA5grid.nc</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">13</span>)]
    

</code></pre></div><h3 id="3--compute-monthly-indices">3 - Compute monthly indices</h3>
<p>We can now open daily files to compute monthly indices.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">yi <span style="color:#f92672">=</span> <span style="color:#ae81ff">1990</span>
yf <span style="color:#f92672">=</span> <span style="color:#ae81ff">2019</span>
<span style="color:#75715e">#########################################################</span>
tmin_in <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Daily/prcp/</span><span style="color:#e6db74">&#39;</span>
monthly_out <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Month_Indice/</span><span style="color:#e6db74">&#39;</span> 

<span style="color:#75715e"># Compute monthly indices</span>
<span style="color:#66d9ef">for</span> year <span style="color:#f92672">in</span> range(yi,yf<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):   <span style="color:#75715e"># loop over years  </span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>):      <span style="color:#75715e"># we just want to work over july (i_month = 7)</span>
        data_pcp <span style="color:#f92672">=</span> tmin_in <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_Prcp_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(year) <span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_{:02d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(i) <span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_ERA5grid.nc</span><span style="color:#e6db74">&#39;</span>
        ds_pcp <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_mfdataset(data_pcp)         
        monthly_pcp <span style="color:#f92672">=</span> ds_pcp<span style="color:#f92672">.</span>sum(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time</span><span style="color:#e6db74">&#39;</span>)     <span style="color:#75715e"># sum over days to calculate monthly accumulation</span>
        <span style="color:#75715e"># we can save our netcdf files</span>
        monthly_pcp<span style="color:#f92672">.</span>to_netcdf(monthly_out <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_Monthly_PrecTOT_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(year) <span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:02d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(i)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_ERA5grid.nc</span><span style="color:#e6db74">&#39;</span>,  format<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">NETCDF4</span><span style="color:#e6db74">&#39;</span>)
            
</code></pre></div><h3 id="4--apply-watershed-netcdf-mask">4 - Apply watershed netcdf mask</h3>
<p>We will mask a specific area using a netcdf file. To create a netcdf file using any shapefile, please follow this <a href="https://www.guillaumedueymes.com/post/shapefile_netcdf/">post</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># this function will be use later to create a netcdf file using source attributs</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_file_from_source</span>(src_file, trg_file):
    src <span style="color:#f92672">=</span> nc<span style="color:#f92672">.</span>Dataset(src_file)
    trg <span style="color:#f92672">=</span> nc<span style="color:#f92672">.</span>Dataset(trg_file, mode<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">w</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#75715e"># Create the dimensions of the file</span>
    <span style="color:#66d9ef">for</span> name, dim <span style="color:#f92672">in</span> src<span style="color:#f92672">.</span>dimensions<span style="color:#f92672">.</span>items():
        trg<span style="color:#f92672">.</span>createDimension(name, len(dim) <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> dim<span style="color:#f92672">.</span>isunlimited() <span style="color:#66d9ef">else</span> None)

    <span style="color:#75715e"># Copy the global attributes</span>
   <span style="color:#75715e"># trg.setncatts({a:src.getncattr(a) for a in src.ncattrs()})</span>

    <span style="color:#75715e"># Create the variables in the file</span>
    <span style="color:#66d9ef">for</span> name, var <span style="color:#f92672">in</span> src<span style="color:#f92672">.</span>variables<span style="color:#f92672">.</span>items():
        trg<span style="color:#f92672">.</span>createVariable(name, var<span style="color:#f92672">.</span>dtype, var<span style="color:#f92672">.</span>dimensions)

        <span style="color:#75715e"># Copy the variable attributes</span>
        trg<span style="color:#f92672">.</span>variables[name]<span style="color:#f92672">.</span>setncatts({a:var<span style="color:#f92672">.</span>getncattr(a) <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> var<span style="color:#f92672">.</span>ncattrs()})

        <span style="color:#75715e"># Copy the variables values (as &#39;f4&#39; eventually)</span>
        <span style="color:#66d9ef">if</span> name <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> tomask:
            trg<span style="color:#f92672">.</span>variables[name][:] <span style="color:#f92672">=</span> src<span style="color:#f92672">.</span>variables[name][:]
            
        <span style="color:#66d9ef">else</span>:    
            trg<span style="color:#f92672">.</span>variables[name][:] <span style="color:#f92672">=</span> data

    <span style="color:#75715e"># Save the file</span>
    trg<span style="color:#f92672">.</span>close()

<span style="color:#75715e">#create 2d grid mask http://meteo.unican.es/work/xarray_seminar/xArray_seminar.html</span>
tomask <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">prcp</span><span style="color:#e6db74">&#39;</span>]

m_f<span style="color:#f92672">=</span>xr<span style="color:#f92672">.</span>open_dataset(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Outaouais_ERA5_Grid.nc</span><span style="color:#e6db74">&#39;</span>)
lat2d<span style="color:#f92672">=</span>m_f<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">latitude</span><span style="color:#e6db74">&#39;</span>][:]
lon2d<span style="color:#f92672">=</span>m_f<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">longitude</span><span style="color:#e6db74">&#39;</span>][:]
mask <span style="color:#f92672">=</span> m_f[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>values

<span style="color:#66d9ef">for</span> year <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1990</span>,<span style="color:#ae81ff">2020</span>):
    <span style="color:#66d9ef">for</span> month <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>):
        
        infile <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Month_Indice/Daymet_v3_Monthly_PrecTOT_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(year) <span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:02d}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(int(month))<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_ERA5grid.nc</span><span style="color:#e6db74">&#39;</span>           
        outfile <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Month_Indice/Daymet_v3_Monthly_PrecTOT_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{:02d}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(month)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_ERA5grid_BV.nc</span><span style="color:#e6db74">&#39;</span>
       
        nc_Modc<span style="color:#f92672">=</span>xr<span style="color:#f92672">.</span>open_dataset(infile)
        nc_Modc<span style="color:#f92672">.</span>lon<span style="color:#f92672">.</span>values
        nc_Modf<span style="color:#f92672">=</span>Dataset(infile,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;</span>)
        data <span style="color:#f92672">=</span> nc_Modc[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">prcp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>where(mask <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
        create_file_from_source(infile, outfile)

</code></pre></div><h3 id="5--compute-correlation">5 - Compute correlation</h3>
<p>To compute spearman correlation, we use stats module from <a href="https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.stats.mstats.spearmanr.html/">scipy library</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> scipy <span style="color:#f92672">import</span> stats
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

variable <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Monthly_PrecTOT</span><span style="color:#e6db74">&#39;</span>
yi <span style="color:#f92672">=</span> <span style="color:#ae81ff">1990</span>
yf <span style="color:#f92672">=</span> <span style="color:#ae81ff">2020</span>
out <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Month_Indice/</span><span style="color:#e6db74">&#39;</span>
<span style="color:#66d9ef">for</span> month <span style="color:#f92672">in</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">07</span><span style="color:#e6db74">&#39;</span>]:  
    <span style="color:#75715e"># load ERA5 </span>
    path_era5 <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">J:/REANALYSES/ERA5/Month_PrecTOT_Outaouais/</span><span style="color:#e6db74">&#39;</span>
    file <span style="color:#f92672">=</span> path_era5 <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ERA5_Outaouais_Monthly_PrecTOT_CAN_</span><span style="color:#e6db74">&#39;</span>
    multi_file <span style="color:#f92672">=</span> [f<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{file}{year}{month}_BV.nc</span><span style="color:#e6db74">&#39;</span> <span style="color:#66d9ef">for</span> year <span style="color:#f92672">in</span> range(yi,yf,<span style="color:#ae81ff">1</span>)]
    era5_all <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>concat([xr<span style="color:#f92672">.</span>open_dataset(f) <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> multi_file], <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">day</span><span style="color:#e6db74">&#39;</span>)
    
    <span style="color:#75715e"># load daymet</span>
    path_daymet <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">K:/PROJETS/PROJET_OUTAOUAIS/Month_Indice/</span><span style="color:#e6db74">&#39;</span>
    
    file <span style="color:#f92672">=</span> path_daymet <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>variable <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span>
    multi_file <span style="color:#f92672">=</span> [f<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{file}{year}{month}_OUTAOUAIS_ERA5grid_BV.nc</span><span style="color:#e6db74">&#39;</span> <span style="color:#66d9ef">for</span> year <span style="color:#f92672">in</span> range(yi,yf,<span style="color:#ae81ff">1</span>)]
    daymet_all <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>concat([xr<span style="color:#f92672">.</span>open_dataset(f) <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> multi_file], <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time</span><span style="color:#e6db74">&#39;</span>)
    
    <span style="color:#75715e"># Spearman correlation between two datasets for each grid point</span>
    corr_spearman_ERA5 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((era5_all[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>],era5_all[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">2</span>]),dtype<span style="color:#f92672">=</span>float)    
    <span style="color:#66d9ef">for</span> ni <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,era5_all[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">2</span>]):   <span style="color:#75715e"># loop over longitudes</span>
        <span style="color:#66d9ef">for</span> nj <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, era5_all[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tp</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]):  <span style="color:#75715e"># loop over latitudes</span>
            
             r, p <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>spearmanr(era5_all<span style="color:#f92672">.</span>isel(latitude<span style="color:#f92672">=</span>[nj], longitude<span style="color:#f92672">=</span>[ni])<span style="color:#f92672">.</span>tp<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>] ,
                                   daymet_all<span style="color:#f92672">.</span>isel(lat<span style="color:#f92672">=</span>[nj], lon<span style="color:#f92672">=</span>[ni])<span style="color:#f92672">.</span>prcp<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>] ) 
             <span style="color:#66d9ef">if</span> p <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span> :
                 corr_spearman_ERA5[nj,ni] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan
             <span style="color:#66d9ef">else</span>:
                 corr_spearman_ERA5[nj,ni] <span style="color:#f92672">=</span> r
                 
    data_set <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>Dataset( coords<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>: ([ <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>], era5_all<span style="color:#f92672">.</span>longitude),
                                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>: ([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>,], era5_all<span style="color:#f92672">.</span>latitude)})
    
    data_set[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">spearmanr</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> ([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>],  corr_spearman_ERA5)
        
    data_set<span style="color:#f92672">.</span>to_netcdf(out <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_spearmann_Correlation_ERA5grid</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> variable <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(yi)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(yf)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>month<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_python.nc</span><span style="color:#e6db74">&#39;</span>)             
             
</code></pre></div><h3 id="6--plot-correlation">6 - Plot correlation</h3>
<p>We can now make a quick plot using matplotlib.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> netCDF4 <span style="color:#f92672">import</span> Dataset
<span style="color:#f92672">import</span> matplotlib.pylab <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> cartopy.crs <span style="color:#f92672">as</span> ccrs
<span style="color:#f92672">import</span> cartopy.feature <span style="color:#f92672">as</span> cfeature
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> matplotlib <span style="color:#f92672">as</span> mpl
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> datetime
<span style="color:#75715e">####https://uoftcoders.github.io/studyGroup/lessons/python/cartography/lesson/</span>

<span style="color:#75715e">## Date à utiliser </span>

path_in<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./Month_Indice/</span><span style="color:#e6db74">&#39;</span>
file <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Daymet_v3_spearmann_Correlation_ERA5gridMonthly_PrecTOT</span><span style="color:#e6db74">&#39;</span>
yi <span style="color:#f92672">=</span> <span style="color:#ae81ff">1990</span>
yf <span style="color:#f92672">=</span> <span style="color:#ae81ff">2020</span>
<span style="color:#75715e"># lecture du contour du bassin versant </span>
BV_border <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./points_contour_BV.csv</span><span style="color:#e6db74">&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">,</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_background</span>(ax):
    ax<span style="color:#f92672">.</span>set_extent([<span style="color:#f92672">-</span><span style="color:#ae81ff">84</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">70</span>,<span style="color:#ae81ff">45</span>,<span style="color:#ae81ff">48</span>])
    ax<span style="color:#f92672">.</span>coastlines(resolution<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">110m</span><span style="color:#e6db74">&#39;</span>);
    ax<span style="color:#f92672">.</span>add_feature(cfeature<span style="color:#f92672">.</span>OCEAN<span style="color:#f92672">.</span>with_scale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">50m</span><span style="color:#e6db74">&#39;</span>))      
    ax<span style="color:#f92672">.</span>add_feature(cfeature<span style="color:#f92672">.</span>LAND<span style="color:#f92672">.</span>with_scale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">50m</span><span style="color:#e6db74">&#39;</span>))       
    ax<span style="color:#f92672">.</span>add_feature(cfeature<span style="color:#f92672">.</span>LAKES<span style="color:#f92672">.</span>with_scale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">50m</span><span style="color:#e6db74">&#39;</span>))     
    ax<span style="color:#f92672">.</span>add_feature(cfeature<span style="color:#f92672">.</span>BORDERS<span style="color:#f92672">.</span>with_scale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">50m</span><span style="color:#e6db74">&#39;</span>))    
    ax<span style="color:#f92672">.</span>add_feature(cfeature<span style="color:#f92672">.</span>RIVERS<span style="color:#f92672">.</span>with_scale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">50m</span><span style="color:#e6db74">&#39;</span>))    
    coast <span style="color:#f92672">=</span> cfeature<span style="color:#f92672">.</span>NaturalEarthFeature(category<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">physical</span><span style="color:#e6db74">&#39;</span>, scale<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">10m</span><span style="color:#e6db74">&#39;</span>,    
                        facecolor<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">none</span><span style="color:#e6db74">&#39;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">coastline</span><span style="color:#e6db74">&#39;</span>)
    ax<span style="color:#f92672">.</span>add_feature(coast, edgecolor<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">black</span><span style="color:#e6db74">&#39;</span>)
    
    states_provinces <span style="color:#f92672">=</span> cfeature<span style="color:#f92672">.</span>NaturalEarthFeature(
        category<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">cultural</span><span style="color:#e6db74">&#39;</span>,
        name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">admin_1_states_provinces_lines</span><span style="color:#e6db74">&#39;</span>,
        scale<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">10m</span><span style="color:#e6db74">&#39;</span>,
        facecolor<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">none</span><span style="color:#e6db74">&#39;</span>)

    ax<span style="color:#f92672">.</span>add_feature(states_provinces, edgecolor<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">gray</span><span style="color:#e6db74">&#39;</span>)

   
    <span style="color:#66d9ef">return</span> ax

<span style="color:#66d9ef">for</span> month <span style="color:#f92672">in</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">07</span><span style="color:#e6db74">&#39;</span>]:
        
    monthstr <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>date(<span style="color:#ae81ff">1900</span>, int(month), <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%</span><span style="color:#e6db74">B</span><span style="color:#e6db74">&#39;</span>)   
    filename <span style="color:#f92672">=</span> path_in <span style="color:#f92672">+</span> file
    
    dset<span style="color:#f92672">=</span>Dataset(filename <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(yi) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(yf) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> month <span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_OUTAOUAIS_python.nc</span><span style="color:#e6db74">&#39;</span>)
    <span style="color:#75715e">## Lecture du fichier </span>
    var<span style="color:#f92672">=</span>dset<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">spearmanr</span><span style="color:#e6db74">&#39;</span>][:]<span style="color:#f92672">.</span>squeeze()
    lon<span style="color:#f92672">=</span>dset<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lon</span><span style="color:#e6db74">&#39;</span>][:]
    lat<span style="color:#f92672">=</span>dset<span style="color:#f92672">.</span>variables[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lat</span><span style="color:#e6db74">&#39;</span>][:]

    
    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">16</span>))
    crs<span style="color:#f92672">=</span>ccrs<span style="color:#f92672">.</span>LambertConformal()
    ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>axes(projection<span style="color:#f92672">=</span>crs)
    plot_background(ax)
    
    <span style="color:#75715e">## Choisissons une colormap</span>
    cmap0 <span style="color:#f92672">=</span> mpl<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>get_cmap(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">jet</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">11</span>)
    <span style="color:#75715e">#cmap0.set_under(&#39;w&#39;) ## on met en blanc les valeurs inferieures au min de clev</span>
    <span style="color:#75715e">#cmap0.set_over(&#39;black&#39;)</span>
    levels <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">0.1</span>) 
    mm <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>contourf(lon,\
                           lat,\
                           var,\
                           vmin<span style="color:#f92672">=</span><span style="color:#ae81ff">0.</span>,\
                           vmax<span style="color:#f92672">=</span><span style="color:#ae81ff">1.1</span>, \
                           transform<span style="color:#f92672">=</span>ccrs<span style="color:#f92672">.</span>PlateCarree(),\
                           cmap<span style="color:#f92672">=</span>cmap0,
                           levels<span style="color:#f92672">=</span>levels)
        
    <span style="color:#75715e"># ajout du contour du basson versant </span>
    colors <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">red</span><span style="color:#e6db74">&#39;</span>]
    maskBV <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Outaouais Watershed</span><span style="color:#e6db74">&#39;</span>]                      
    ax<span style="color:#f92672">.</span>plot(BV_border<span style="color:#f92672">.</span>X,BV_border<span style="color:#f92672">.</span>Y, transform<span style="color:#f92672">=</span>ccrs<span style="color:#f92672">.</span>PlateCarree(), color<span style="color:#f92672">=</span>colors[<span style="color:#ae81ff">0</span>], linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, label<span style="color:#f92672">=</span>maskBV[<span style="color:#ae81ff">0</span>])
    plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">best</span><span style="color:#e6db74">&#34;</span>, markerscale<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)
    xticks <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#f92672">-</span><span style="color:#ae81ff">150.0</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">40.0</span>,<span style="color:#ae81ff">20</span>)
    yticks <span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">10</span>)    
    fig<span style="color:#f92672">.</span>canvas<span style="color:#f92672">.</span>draw()    

    cbar <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>colorbar(mm, orientation<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">horizontal</span><span style="color:#e6db74">&#39;</span>, shrink<span style="color:#f92672">=</span><span style="color:#ae81ff">0.75</span>, drawedges<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">True</span><span style="color:#e6db74">&#39;</span>, ticks<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>),extend<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">both</span><span style="color:#e6db74">&#39;</span>)
    cbar<span style="color:#f92672">.</span>set_label(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> DAYMET/ERA Correlation - Résolution: 32km</span><span style="color:#e6db74">&#39;</span>, size<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">medium</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># Affichage de la légende de la barre de couleur</span>
    cbar<span style="color:#f92672">.</span>ax<span style="color:#f92672">.</span>tick_params(labelsize<span style="color:#f92672">=</span><span style="color:#ae81ff">17</span>)  
    
    string_title<span style="color:#f92672">=</span><span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spearman Correlation Monthly total precipitation Daymet/ERA5 </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> monthstr <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> reference period 1990-2019</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
    plt<span style="color:#f92672">.</span>title(string_title, size<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">xx-large</span><span style="color:#e6db74">&#39;</span>)
    plt<span style="color:#f92672">.</span>savefig(path_in <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spearman_DAYMET_ERA5_PrecTOT_1990-2019_</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>str(month)<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_python.png</span><span style="color:#e6db74">&#39;</span>, bbox_inches<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">tight</span><span style="color:#e6db74">&#39;</span>, pad_inches<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
    plt<span style="color:#f92672">.</span>show()  
    plt<span style="color:#f92672">.</span>close()
</code></pre></div><p><img src="output_13_0.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
</code></pre></div>
    </div>

    







<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/spearman/&amp;text=Spearman%20correlation%20between%20two%20Netcdf%20datasets" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/spearman/&amp;t=Spearman%20correlation%20between%20two%20Netcdf%20datasets" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Spearman%20correlation%20between%20two%20Netcdf%20datasets&amp;body=/post/spearman/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/spearman/&amp;title=Spearman%20correlation%20between%20two%20Netcdf%20datasets" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Spearman%20correlation%20between%20two%20Netcdf%20datasets%20/post/spearman/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/spearman/&amp;title=Spearman%20correlation%20between%20two%20Netcdf%20datasets" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  






  
  
  
    
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hued2496a182fbb6fc8c711157078d29a6_5348924_250x250_fill_q90_lanczos_center.jpg" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/">Guillaume Dueymes</a></h5>
      <h6 class="card-subtitle">Data Scientist and Research Assistant</h6>
      <p class="card-text">My research interests include data science, data management and climate science.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.researchgate.net/profile/Guillaume_Dueymes" target="_blank" rel="noopener">
        <i class="fab fa-researchgate"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/guimeto" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>









  
  



  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js" integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js"></script>
        
      

      
      
    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.bcfae8267aba63cc55af53a503896bd9.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
