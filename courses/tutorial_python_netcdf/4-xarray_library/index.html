<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.6.2">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Guillaume Dueymes">

  
  
  
    
  
  <meta name="description" content="In this tutorial, we will use the features of the Python xarray library to process and analyze Netcdf files.
To install the library under anaconda:
$ conda install xarray
Here is an example of structure of a Netcdf file under xarray:
 DataArray 
xarray.DataArray is xarray’s implementation of a labeled, multi-dimensional array. It has several key properties: | | | |&ndash;|&ndash;| | values | a numpy.ndarray holding the array’s values | | dims | dimension names for each axis (e.">

  
  <link rel="alternate" hreflang="en-us" href="/courses/tutorial_python_netcdf/4-xarray_library/">

  


  
  
  
  <meta name="theme-color" content="#3f51b5">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/courses/tutorial_python_netcdf/4-xarray_library/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="GDueymes">
  <meta property="og:url" content="/courses/tutorial_python_netcdf/4-xarray_library/">
  <meta property="og:title" content="4 Xarray | GDueymes">
  <meta property="og:description" content="In this tutorial, we will use the features of the Python xarray library to process and analyze Netcdf files.
To install the library under anaconda:
$ conda install xarray
Here is an example of structure of a Netcdf file under xarray:
 DataArray 
xarray.DataArray is xarray’s implementation of a labeled, multi-dimensional array. It has several key properties: | | | |&ndash;|&ndash;| | values | a numpy.ndarray holding the array’s values | | dims | dimension names for each axis (e."><meta property="og:image" content="/img/icon-192.png">
  <meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2019-05-05T00:00:00&#43;01:00">
    
    <meta property="article:modified_time" content="2019-05-05T00:00:00&#43;01:00">
  

  



  


  


  





  <title>4 Xarray | GDueymes</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    
    
      <a class="navbar-brand" href="/">GDueymes</a>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/courses/"><span>Courses</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/Guillaume_Dueymes2019.pdf"><span>CV</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      

    </ul>

  </div>
</nav>


  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      





  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
  <input name="q" type="search" class="form-control" placeholder="Search..." autocomplete="off">
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/courses/tutorial_python_netcdf/">Python Netcdf</a>

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/courses/tutorial_python_netcdf/1-netcdf_tutorial/">Tutorial Python Netcdf</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/courses/tutorial_python_netcdf/1-netcdf_tutorial/">1 Netcdf Part 1</a>
      </li>
      
      <li >
        <a href="/courses/tutorial_python_netcdf/2-netcdf_tutorial_2/">2 Netcdf Part 2</a>
      </li>
      
      <li >
        <a href="/courses/tutorial_python_netcdf/3-cartopy_library/">3 Cartopy</a>
      </li>
      
      <li class="active">
        <a href="/courses/tutorial_python_netcdf/4-xarray_library/">4 Xarray</a>
      </li>
      
    </ul>
    

  </div>
  
  
</nav>

    </div>

    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>

      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1-open-a-netcdf-file">1- Open a Netcdf file</a></li>
<li><a href="#2-exploring-the-data">2- Exploring the data</a></li>
<li><a href="#3-basic-operations-with-xarray">3- Basic operations with Xarray:</a></li>
<li><a href="#4-select-grid-points-from-netcdf-file-using-xarray">4- Select grid points from Netcdf file using Xarray</a>
<ul>
<li><a href="#gridpoint-to-extract-the-closest-grid-point-of-a-latitude-longitude">Gridpoint:  to extract the closest grid point of a latitude / longitude:</a></li>
<li><a href="#gridpoints-to-extract-a-list-of-points">Gridpoints:  to extract a list of points</a></li>
<li><a href="#to-extract-an-area-or-subdomain-delimited-by-latitude-and-longitude-values-slicing">To extract an area or subdomain delimited by latitude and longitude values: .slicing()</a></li>
<li><a href="#to-mask-an-area-delimited-by-a-shapefile">To mask an area delimited by a Shapefile:</a></li>
</ul></li>
<li><a href="#5-last-example-using-xarray">5- Last example using Xarray:</a></li>
</ul></li>
</ul>
</nav>

      
    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <h1>4 Xarray</h1>

          <div class="article-style">
            

<p>In this tutorial, we will use the features of the Python xarray library to process and analyze Netcdf files.</p>

<p>To install the library under anaconda:</p>

<p>$ conda install xarray</p>

<p>Here is an example of structure of a Netcdf file under xarray:</p>

<p><img src="/img/netcdf/xarray.png" alt="image0" /></p>

<p><b> DataArray </b></p>

<p>xarray.DataArray is xarray’s implementation of a labeled, multi-dimensional array. It has several key properties:
|  |  |
|&ndash;|&ndash;|
| <b>values</b> |  a numpy.ndarray holding the array’s values |
| <b>dims</b> |  dimension names for each axis (e.g., (&lsquo;x&rsquo;, &lsquo;y&rsquo;, &lsquo;z&rsquo;,&lsquo;time&rsquo;)) |
| <b>coords</b> | a dict-like container of arrays (coordinates) that label each point (e.g., 1-dimensional arrays of numbers, datetime objects or strings) |
| <b>attrs</b> |  an OrderedDict to hold arbitrary metadata (attributes) |</p>

<p><b> DataSet </b></p>

<p>xarray.Dataset is xarray’s multi-dimensional equivalent of a DataFrame. It is a dict-like container of labeled arrays (DataArray objects) with aligned dimensions. It is designed as an in-memory representation of the data model from the netCDF file format.</p>

<p>xarray.DataSet is a collection of DataArrays. Each NetCDF file contains a DataSet.</p>

<h2 id="1-open-a-netcdf-file">1- Open a Netcdf file</h2>

<p>We will open and store the data of a Netcdf file in a Dataset.</p>

<p>First we need to import librairies and create aliases.</p>

<pre><code class="language-python">import xarray as xr
import warnings; warnings.filterwarnings(action='ignore')
from matplotlib import pyplot as plt
%matplotlib inline
plt.rcParams['figure.figsize'] = (8,5)
</code></pre>

<ul>
<li>To import and store as dataset only one Netcdf file:</li>
</ul>

<p>We will work with temperature fields from cera20c reanalysis.</p>

<pre><code class="language-python">unique_dataDIR = './DATA/CERA20C/cera20c_member0_TAS_197101_day.nc'
TAS = xr.open_dataset(unique_dataDIR)
TAS
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 31)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-01-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] ...
    t2m        (time, latitude, longitude) float32 ...
Attributes:
    CDI:          Climate Data Interface version 1.6.9 (http://mpimet.mpg.de/...
    Conventions:  CF-1.6
    history:      Thu Oct 25 14:29:40 2018: cdo daymean ./TAS/cera20c_member0...
    CDO:          Climate Data Operators version 1.6.9 (http://mpimet.mpg.de/...
</code></pre>

<ul>
<li>If we want to import several Netcdf files:</li>
</ul>

<p>Here, we want to store all files&rsquo; names starting with &lsquo;cera20c_member0<em>TAS</em>&rsquo; and located in &lsquo;./data/cera20c/&rsquo; path.</p>

<pre><code class="language-python">multi_dataDIR = './DATA/CERA20C/cera20c_member0_TAS_*.nc'
TAS2 = xr.open_mfdataset(multi_dataDIR)
TAS2
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 365)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
Attributes:
    CDI:          Climate Data Interface version 1.6.9 (http://mpimet.mpg.de/...
    Conventions:  CF-1.6
    history:      Thu Oct 25 14:29:40 2018: cdo daymean ./TAS/cera20c_member0...
    CDO:          Climate Data Operators version 1.6.9 (http://mpimet.mpg.de/...
</code></pre>

<ul>
<li>Combine Netcdf:</li>
</ul>

<p>To combine variables and coordinates between multiple DataArray and/or Dataset objects, use merge(). It can merge a list of Dataset, DataArray or dictionaries of objects convertible to DataArray objects:</p>

<pre><code class="language-python">multi_dataDIR = './DATA/CERA20C/cera20c_member0_TAS_*.nc'
TAS2 = xr.open_mfdataset(multi_dataDIR)
multi_dataDIR2 = './DATA/CERA20C/cera20c_member0_SIC_*.nc'
SIC2 = xr.open_mfdataset(multi_dataDIR2)

DS_new = xr.merge([TAS2,SIC2])
DS_new
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 365)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
</code></pre>

<h2 id="2-exploring-the-data">2- Exploring the data</h2>

<p>We can quickly explore our datasets by using some methods of the xarray library:</p>

<ul>
<li>DS.var</li>
<li>DS.dims</li>
<li>DS.coords</li>

<li><p>DS.attrs</p>

<pre><code class="language-python">DS_new.var
</code></pre>

<p><bound method ImplementsDatasetReduce._reduce_method.<locals>.wrapped_func of <xarray.Dataset>
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 365)
Coordinates:</p>

<ul>
<li>longitude  (longitude) float32 0.0 1.25 2.5 3.75 &hellip; 356.25 357.5 358.75</li>
<li>latitude   (latitude) float32 90.0 88.75 87.5 86.25 &hellip; -87.5 -88.75 -90.0</li>

<li><p>time       (time) datetime64[ns] 1971-01-01T10:30:00 &hellip; 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
time_bnds  (time, bnds) datetime64[ns] dask.array<shape=(365, 2), chunksize=(31, 2)>
t2m        (time, latitude, longitude) float32 dask.array<shape=(365, 145, 288), chunksize=(31, 145, 288)>
siconc     (time, latitude, longitude) float32 dask.array<shape=(365, 145, 288), chunksize=(31, 145, 288)>&gt;</p>

<pre><code class="language-python">DS_new.dims
</code></pre></li>
</ul>

<p>Frozen(SortedKeysDict({&lsquo;longitude&rsquo;: 288, &lsquo;latitude&rsquo;: 145, &lsquo;time&rsquo;: 365, &lsquo;bnds&rsquo;: 2}))</p>

<pre><code class="language-python">DS_new.coords
</code></pre>

<p>Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 &hellip; 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 &hellip; -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 &hellip; 1971-12-31T10:30:00</p>

<pre><code class="language-python">DS_new.attrs
</code></pre>

<p>OrderedDict()</p></li>
</ul>

<h2 id="3-basic-operations-with-xarray">3- Basic operations with Xarray:</h2>

<ul>
<li>Select a date:</li>
</ul>

<p>We can use .sel() method to select one timestamp from our Dataset.</p>

<pre><code class="language-python">DS_date = DS_new.sel(time='1971-01-01')
DS_date
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 1)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(1, 2), chunksize=(1, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(1, 145, 288), chunksize=(1, 145, 288)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(1, 145, 288), chunksize=(1, 145, 288)&gt;
</code></pre>

<ul>
<li>Select time range</li>
</ul>

<p>We can select a time range with slicing</p>

<pre><code class="language-python">DS_date_range = DS_new.sel(time=slice('1971-06-01', '1971-08-31'))
DS_date_range
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 92)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-06-01T10:30:00 ... 1971-08-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(92, 2), chunksize=(30, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(92, 145, 288), chunksize=(30, 145, 288)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(92, 145, 288), chunksize=(30, 145, 288)&gt;
</code></pre>

<ul>
<li>Export a dataset</li>
</ul>

<p>We can export our dataset into dataframe and then use Pandas library to make analysis.</p>

<pre><code class="language-python">df = DS_date_range.to_dataframe()
</code></pre>

<pre><code class="language-python">df.head()
</code></pre>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">time_bnds</th>
<th align="right">t2m</th>
<th align="right">siconc</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">(0, 90.0, 0.0, Timestamp(&lsquo;1971-06-01 10:30:00&rsquo;))</td>
<td align="left">1971-06-01 00:00:00</td>
<td align="right">266.296</td>
<td align="right">0.990234</td>
</tr>

<tr>
<td align="left">(0, 90.0, 0.0, Timestamp(&lsquo;1971-06-02 10:30:00&rsquo;))</td>
<td align="left">1971-06-02 00:00:00</td>
<td align="right">264.76</td>
<td align="right">0.988525</td>
</tr>

<tr>
<td align="left">(0, 90.0, 0.0, Timestamp(&lsquo;1971-06-03 10:30:00&rsquo;))</td>
<td align="left">1971-06-03 00:00:00</td>
<td align="right">265.866</td>
<td align="right">0.987502</td>
</tr>

<tr>
<td align="left">(0, 90.0, 0.0, Timestamp(&lsquo;1971-06-04 10:30:00&rsquo;))</td>
<td align="left">1971-06-04 00:00:00</td>
<td align="right">265.947</td>
<td align="right">0.98738</td>
</tr>

<tr>
<td align="left">(0, 90.0, 0.0, Timestamp(&lsquo;1971-06-05 10:30:00&rsquo;))</td>
<td align="left">1971-06-05 00:00:00</td>
<td align="right">266.126</td>
<td align="right">0.987152</td>
</tr>
</tbody>
</table>

<pre><code class="language-python">df.describe()
</code></pre>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="right">t2m</th>
<th align="right">siconc</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">count</td>
<td align="right">7.68384e+06</td>
<td align="right">7.68384e+06</td>
</tr>

<tr>
<td align="left">mean</td>
<td align="right">267.002</td>
<td align="right">0.141752</td>
</tr>

<tr>
<td align="left">std</td>
<td align="right">25.852</td>
<td align="right">0.312001</td>
</tr>

<tr>
<td align="left">min</td>
<td align="right">192.562</td>
<td align="right">0</td>
</tr>

<tr>
<td align="left">25%</td>
<td align="right">273.221</td>
<td align="right">0</td>
</tr>

<tr>
<td align="left">50%</td>
<td align="right">285.734</td>
<td align="right">0</td>
</tr>

<tr>
<td align="left">75%</td>
<td align="right">296.388</td>
<td align="right">0</td>
</tr>

<tr>
<td align="left">max</td>
<td align="right">314.804</td>
<td align="right">1</td>
</tr>
</tbody>
</table>

<ul>
<li><p>Time mean</p>

<pre><code class="language-python">Mean_array = DS_date_range.mean(dim='time')
Mean_array.values
</code></pre>

<p><bound method Mapping.values of <xarray.Dataset>
Dimensions:    (latitude: 145, longitude: 288)
Coordinates:</p>

<ul>
<li>longitude  (longitude) float32 0.0 1.25 2.5 3.75 &hellip; 356.25 357.5 358.75</li>
<li>latitude   (latitude) float32 90.0 88.75 87.5 86.25 &hellip; -87.5 -88.75 -90.0
Data variables:
t2m        (latitude, longitude) float32 dask.array<shape=(145, 288), chunksize=(145, 288)>
siconc     (latitude, longitude) float32 dask.array<shape=(145, 288), chunksize=(145, 288)>&gt;</li>
</ul></li>

<li><p>To save our results into csv:</p>

<pre><code class="language-python">Mean_array.t2m.to_dataframe().to_csv('./DATA/CERA20C_T2m_mean.csv')
</code></pre></li>

<li><p>Mean over all latitudes and longitudes grid points:</p>

<pre><code class="language-python">DS_date_range.t2m.mean(dim=('latitude', 'longitude'))
</code></pre>

<p><xarray.DataArray 't2m' (time: 92)>
dask.array<shape=(92,), dtype=float32, chunksize=(30,)>
Coordinates:</p>

<ul>
<li><p>time     (time) datetime64[ns] 1971-06-01T10:30:00 &hellip; 1971-08-31T10:30:00</p>

<pre><code class="language-python">DS_date_range.t2m.mean(dim=('latitude', 'longitude')).plot()
</code></pre></li>
</ul>

<p>[<matplotlib.lines.Line2D at 0xabe86a0>]</p></li>
</ul>

<p><img src="/img/netcdf/output_27_1.png" alt="png" /></p>

<ul>
<li><p>To save into csv:</p>

<pre><code class="language-python">DS_date_range.t2m.mean(dim=('time', 'longitude')).to_dataframe().to_csv('./DATA/CERA20C_T2m_2Dmean.csv')
</code></pre></li>

<li><p>Quick plot with Xarray</p>

<pre><code class="language-python">import cartopy.crs as ccrs
fig=plt.figure(figsize=(10,10), frameon=True) 

ax = plt.axes(projection=ccrs.Orthographic(-80, 35))
Mean_array.t2m.plot.contourf(ax=ax, transform=ccrs.PlateCarree());
ax.set_global(); ax.coastlines();
</code></pre></li>
</ul>

<p><img src="/img/netcdf/output_31_0.png" alt="png" /></p>

<ul>
<li>Basic operations with Xarray:</li>
</ul>

<p>In this example, we will mean DS_date_range over time and apply a substration to change units.</p>

<pre><code class="language-python">centigrade = DS_date_range.t2m.mean(dim='time') - 273.16
centigrade.values
</code></pre>

<pre><code>array([[ -1.2229004,  -1.2229004,  -1.2229004, ...,  -1.2229004,
         -1.2229004,  -1.2229004],
       [ -1.3348389,  -1.3311157,  -1.3274231, ...,  -1.3488159,
         -1.3442383,  -1.3395386],
       [ -1.6027222,  -1.5914001,  -1.5804138, ...,  -1.6451721,
         -1.631012 ,  -1.6168518],
       ...,
       [-58.547928 , -58.5663   , -58.58455  , ..., -58.314026 ,
        -58.391983 , -58.46997  ],
       [-59.556473 , -59.577957 , -59.59955  , ..., -59.478424 ,
        -59.50441  , -59.53041  ],
       [-60.739105 , -60.739105 , -60.739105 , ..., -60.739105 ,
        -60.739105 , -60.739105 ]], dtype=float32)
</code></pre>

<pre><code class="language-python">fig=plt.figure(figsize=(10,10), frameon=True)
ax = plt.axes(projection=ccrs.Orthographic(-80, 35))
centigrade.plot.contourf(ax=ax, transform=ccrs.PlateCarree());
ax.set_global(); ax.coastlines();
</code></pre>

<p><img src="/img/netcdf/output_34_0.png" alt="png" /></p>

<ul>
<li>Groupby() method:</li>
</ul>

<p>groupdby() method with Xarray is very usefull to group our datasets by month, season, year&hellip; and then apply function to compute indices.</p>

<pre><code class="language-python">DS_new
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 145, longitude: 288, time: 365)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
</code></pre>

<pre><code class="language-python"># monthly mean:
DS_month = DS_new.groupby('time.month').mean('time')
DS_month
#DS_month.to_dataframe()
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288, month: 12)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * month      (month) int64 1 2 3 4 5 6 7 8 9 10 11 12
Data variables:
    t2m        (month, latitude, longitude) float32 dask.array&lt;shape=(12, 145, 288), chunksize=(1, 145, 288)&gt;
    siconc     (month, latitude, longitude) float32 dask.array&lt;shape=(12, 145, 288), chunksize=(1, 145, 288)&gt;
</code></pre>

<p>We can use this method to compute climatology and then anomalies.</p>

<pre><code class="language-python">climatology = DS_new.groupby('time.month').mean('time')
anomalies = DS_new.groupby('time.month') - climatology
anomalies
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288, time: 365)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
    month      (time) int64 1 1 1 1 1 1 1 1 1 1 ... 12 12 12 12 12 12 12 12 12
Data variables:
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(365, 145, 288), chunksize=(31, 145, 288)&gt;
</code></pre>

<pre><code class="language-python"># seaon mean:
DS_season = DS_new.groupby('time.season').mean('time')
DS_season
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288, season: 4)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * season     (season) object 'DJF' 'JJA' 'MAM' 'SON'
Data variables:
    t2m        (season, latitude, longitude) float32 dask.array&lt;shape=(4, 145, 288), chunksize=(1, 145, 288)&gt;
    siconc     (season, latitude, longitude) float32 dask.array&lt;shape=(4, 145, 288), chunksize=(1, 145, 288)&gt;
</code></pre>

<pre><code class="language-python"># year mean:
DS_year = DS_new.groupby('time.year').mean('time')
DS_year
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288, year: 1)
Coordinates:
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * year       (year) int64 1971
Data variables:
    t2m        (year, latitude, longitude) float32 dask.array&lt;shape=(1, 145, 288), chunksize=(1, 145, 288)&gt;
    siconc     (year, latitude, longitude) float32 dask.array&lt;shape=(1, 145, 288), chunksize=(1, 145, 288)&gt;
</code></pre>

<ul>
<li><p>to select a specific season:</p>

<pre><code class="language-python">DS_winter = DS_season.sel(season='DJF')
DS_winter
</code></pre>

<p><xarray.Dataset>
Dimensions:    (latitude: 145, longitude: 288)
Coordinates:</p>

<ul>
<li>longitude  (longitude) float32 0.0 1.25 2.5 3.75 &hellip; 356.25 357.5 358.75</li>
<li>latitude   (latitude) float32 90.0 88.75 87.5 86.25 &hellip; -87.5 -88.75 -90.0
season     <U3 'DJF'
Data variables:
t2m        (latitude, longitude) float32 dask.array<shape=(145, 288), chunksize=(145, 288)>
siconc     (latitude, longitude) float32 dask.array<shape=(145, 288), chunksize=(145, 288)></li>
</ul></li>
</ul>

<p>In the example below, we will group the xarray.DataArray data by season, calculate the average, apply a simple arrhythmic operation and plot the resulting fields for each season.</p>

<pre><code class="language-python">DS_Season = DS_new.t2m.groupby('time.season').mean('time')- 273.15
fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(9,5))
j = 0
for i, season in enumerate(('DJF', 'MAM', 'JJA', 'SON')):
    if season =='JJA':
        j += 1
        i = 0
    elif season =='SON':
        i = 1
        
    DS_Season.sel(season=season).plot.pcolormesh(
        ax=axes[i, j], vmin=-30, vmax=30, cmap='Spectral_r',
        add_colorbar=True, extend='both')

for ax in axes.flat:
    ax.axes.get_xaxis().set_ticklabels([])
    ax.axes.get_yaxis().set_ticklabels([])
    ax.axes.axis('tight')
   
plt.tight_layout()
fig.suptitle('Seasonal Surface Air Temperature', fontsize=16, y=1.02)
</code></pre>

<pre><code>Text(0.5, 1.02, 'Seasonal Surface Air Temperature')
</code></pre>

<p><img src="/img/netcdf/output_45_1.png" alt="png" /></p>

<pre><code class="language-python">
lat_bnd = [80, 50]
lon_bnd = [250, 310]
DS_Season = DS_new.sel(longitude=slice(*lon_bnd), latitude=slice(*lat_bnd),).siconc.groupby('time.season').mean('time') *100

fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(16,10))
j = 0
for i, season in enumerate(('DJF', 'MAM', 'JJA', 'SON')):
    if season =='JJA':
        j += 1
        i = 0
    elif season =='SON':
        i = 1
        
    DS_Season.sel(season=season).plot.pcolormesh(
        ax=axes[i, j], vmin=0, vmax=100, cmap='Spectral_r',
        add_colorbar=True, extend='both')
for ax in axes.flat:
    ax.axes.get_xaxis().set_ticklabels([])
    ax.axes.get_yaxis().set_ticklabels([])
    ax.axes.axis('tight')
   
plt.tight_layout()
fig.suptitle('Seasonal Sea Ice Concentration', fontsize=16, y=1.02)
</code></pre>

<pre><code>Text(0.5, 1.02, 'Seasonal Sea Ice Concentration')
</code></pre>

<p><img src="/img/netcdf/output_46_1.png" alt="png" /></p>

<p>To save our result into Netcdf:</p>

<pre><code class="language-python">DS_season = DS_new.groupby('time.season').mean('time')
dataDIR = './DATA/CERA20C_season.nc'
DS_Season.to_netcdf(dataDIR)

</code></pre>

<h2 id="4-select-grid-points-from-netcdf-file-using-xarray">4- Select grid points from Netcdf file using Xarray</h2>

<p>In the previous section we applied the .sel () method to work on the time dimension. This method can be used on spatial dimensions to extract points or study areas from our netcdf file.</p>

<h3 id="gridpoint-to-extract-the-closest-grid-point-of-a-latitude-longitude">Gridpoint:  to extract the closest grid point of a latitude / longitude:</h3>

<pre><code class="language-python">lati = 45.5
loni = 269.2
data  = DS_new.sel(longitude=loni  , latitude=lati  , method='nearest') 
data
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, time: 365)
Coordinates:
    longitude  float32 268.75
    latitude   float32 45.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time) float32 dask.array&lt;shape=(365,), chunksize=(31,)&gt;
    siconc     (time) float32 dask.array&lt;shape=(365,), chunksize=(31,)&gt;
</code></pre>

<pre><code class="language-python">data['t2m'] = data['t2m'] - 273.15
</code></pre>

<pre><code class="language-python">data.t2m
</code></pre>

<pre><code>&lt;xarray.DataArray 't2m' (time: 365)&gt;
dask.array&lt;shape=(365,), dtype=float32, chunksize=(31,)&gt;
Coordinates:
    longitude  float32 268.75
    latitude   float32 45.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
</code></pre>

<p>We can convert our selection into a DataFrame and then use Pandas to analyse our results.</p>

<pre><code class="language-python">df = data.t2m.to_dataframe()
fig = plt.figure(figsize=(16,8))
df['t2m'].plot()
</code></pre>

<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x13660400&gt;
</code></pre>

<p><img src="/img/netcdf/output_55_1.png" alt="png" /></p>

<h3 id="gridpoints-to-extract-a-list-of-points">Gridpoints:  to extract a list of points</h3>

<pre><code class="language-python">lats =  [20.0,50.0,90.0]
lons =  [60.0,80.0,120.0]

data  = DS_new.sel(longitude=lons  , latitude=lats  , method='nearest')
data['t2m'] = data['t2m']-273.15
data
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 3, longitude: 3, time: 365)
Coordinates:
  * longitude  (longitude) float32 60.0 80.0 120.0
  * latitude   (latitude) float32 20.0 50.0 90.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 3, 3), chunksize=(31, 3, 3)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(365, 3, 3), chunksize=(31, 3, 3)&gt;
</code></pre>

<pre><code class="language-python">fig = plt.figure(figsize=(16,8))
data.t2m.sel(longitude=60.0, latitude=[20.0,50.0,90.0]).plot.line(x='time')
</code></pre>

<pre><code>[&lt;matplotlib.lines.Line2D at 0xdf31ac8&gt;,
 &lt;matplotlib.lines.Line2D at 0xdd0bf28&gt;,
 &lt;matplotlib.lines.Line2D at 0xdd0b4a8&gt;]
</code></pre>

<p><img src="/img/netcdf/output_58_1.png" alt="png" /></p>

<h3 id="to-extract-an-area-or-subdomain-delimited-by-latitude-and-longitude-values-slicing">To extract an area or subdomain delimited by latitude and longitude values: .slicing()</h3>

<pre><code class="language-python">lat_bnd = [80, 50]
lon_bnd = [250, 310]
area = DS_new.sel(longitude=slice(*lon_bnd), latitude=slice(*lat_bnd),)
area
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, latitude: 25, longitude: 49, time: 365)
Coordinates:
  * longitude  (longitude) float32 250.0 251.25 252.5 ... 307.5 308.75 310.0
  * latitude   (latitude) float32 80.0 78.75 77.5 76.25 ... 52.5 51.25 50.0
  * time       (time) datetime64[ns] 1971-01-01T10:30:00 ... 1971-12-31T10:30:00
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] dask.array&lt;shape=(365, 2), chunksize=(31, 2)&gt;
    t2m        (time, latitude, longitude) float32 dask.array&lt;shape=(365, 25, 49), chunksize=(31, 25, 49)&gt;
    siconc     (time, latitude, longitude) float32 dask.array&lt;shape=(365, 25, 49), chunksize=(31, 25, 49)&gt;
</code></pre>

<pre><code class="language-python">area.longitude.values
</code></pre>

<pre><code>array([250.  , 251.25, 252.5 , 253.75, 255.  , 256.25, 257.5 , 258.75,
       260.  , 261.25, 262.5 , 263.75, 265.  , 266.25, 267.5 , 268.75,
       270.  , 271.25, 272.5 , 273.75, 275.  , 276.25, 277.5 , 278.75,
       280.  , 281.25, 282.5 , 283.75, 285.  , 286.25, 287.5 , 288.75,
       290.  , 291.25, 292.5 , 293.75, 295.  , 296.25, 297.5 , 298.75,
       300.  , 301.25, 302.5 , 303.75, 305.  , 306.25, 307.5 , 308.75,
       310.  ], dtype=float32)
</code></pre>

<p>To visualize our area::</p>

<pre><code class="language-python">import cartopy.crs as ccrs
import cartopy.feature as cfeat
def make_figure():
    fig = plt.figure(figsize=(22, 12))
    ax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree())

    # generate a basemap with country borders, oceans and coastlines
    ax.add_feature(cfeat.LAND)
    ax.add_feature(cfeat.OCEAN)
    ax.add_feature(cfeat.COASTLINE)
    ax.add_feature(cfeat.BORDERS, linestyle='dotted')
    return fig, ax

make_figure();
</code></pre>

<p><img src="/img/netcdf/output_63_0.png" alt="png" /></p>

<pre><code class="language-python">_, ax = make_figure()
# plot the temperature field
area.t2m[0].plot()
</code></pre>

<pre><code>&lt;matplotlib.collections.QuadMesh at 0xb2e9240&gt;
</code></pre>

<p><img src="/img/netcdf/output_64_1.png" alt="png" /></p>

<h3 id="to-mask-an-area-delimited-by-a-shapefile">To mask an area delimited by a Shapefile:</h3>

<p>To do this, we need to import two more librairies:
- Geopandas: conda install -c conda-forge geopandas
- osgeo: conda install -c conda-forge gdal</p>

<p>The next function will open a shapefile, read the polygons and make a mask from each grid points of our Netcdf inside the polygons.</p>

<pre><code class="language-python">from osgeo import ogr
import geopandas as gpd
import numpy as np
def get_mask(lons2d, lats2d, shp_path=&quot;&quot;, polygon_name=None):
    &quot;&quot;&quot;
    Assumes that the shape file contains polygons in lat lon coordinates
    :param lons2d:
    :param lats2d:
    :param shp_path:
    :rtype : np.ndarray
    The mask is 1 for the points inside of the polygons
    &quot;&quot;&quot;
    ds = ogr.Open(shp_path)
    &quot;&quot;&quot;
    :type : ogr.DataSource
    &quot;&quot;&quot;

    xx = lons2d.copy()
    yy = lats2d

    # set longitudes to be from -180 to 180
    xx[xx &gt; 180] -= 360

    mask = np.zeros(lons2d.shape, dtype=int)
    nx, ny = mask.shape

    pt = ogr.Geometry(ogr.wkbPoint)

    for i in range(ds.GetLayerCount()):
        layer = ds.GetLayer(i)
        &quot;&quot;&quot;
        :type : ogr.Layer
        &quot;&quot;&quot;

        for j in range(layer.GetFeatureCount()):
            feat = layer.GetFeature(j)
            &quot;&quot;&quot;
            :type : ogr.Feature
            &quot;&quot;&quot;

            # Select polygons by the name property
            if polygon_name is not None:
                if not feat.GetFieldAsString(&quot;NAME&quot;) == polygon_name:
                    continue

            g = feat.GetGeometryRef()
            &quot;&quot;&quot;
            :type : ogr.Geometry
            &quot;&quot;&quot;

            assert isinstance(g, ogr.Geometry)

            for pi in range(nx):
                for pj in range(ny):
                    pt.SetPoint_2D(0, float(xx[pi, pj]), float(yy[pi, pj]))

                    mask[pi, pj] += int(g.Contains(pt))

    return mask

</code></pre>

<p>We first read the Netcdf file and store informations in a Xarray.dataset.</p>

<pre><code class="language-python">ds = xr.open_dataset('./DATA/CERA20C/cera20c_member0_TAS_197101_day.nc')
</code></pre>

<p>We then need to extract latitudes and longitudes values and compute a 2D matrix.</p>

<pre><code class="language-python">Imp_Lats =  ds['latitude'].values
Imp_Lons =  ds['longitude'].values
lon2d, lat2d = np.meshgrid(Imp_Lons, Imp_Lats)
</code></pre>

<pre><code class="language-python">ds_mean = ds.mean('time') - 273.15
ds_mean
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288)
Coordinates:
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
Data variables:
    t2m        (latitude, longitude) float32 -34.067184 ... -25.249802
</code></pre>

<p>We open the shape file with Geopandas library.</p>

<pre><code class="language-python">shapes = gpd.read_file(&quot;./DATA/Shapefiles/Countries_Final-polygon.shp&quot;)
list(shapes.columns.values)
</code></pre>

<pre><code>['FIPS',
 'ISO2',
 'ISO3',
 'UN',
 'NAME',
 'AREA',
 'POP2005',
 'REGION',
 'SUBREGION',
 'LON',
 'LAT',
 'layer',
 'path',
 'geometry']
</code></pre>

<pre><code class="language-python">shapes.head()
</code></pre>

<pre><code class="language-python">shapes.loc[27, 'geometry']
shapes.plot()
</code></pre>

<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0xd8b4b70&gt;
</code></pre>

<p><img src="/img/netcdf/output_75_1.png" alt="png" /></p>

<p>We want in our study to extract information inside Mexico shapefile.</p>

<pre><code class="language-python">mask=get_mask(lon2d,lat2d,shp_path=&quot;./DATA/Shapefiles/Countries_Final-polygon.shp&quot;, polygon_name='Mexico') 
np.max(mask)
</code></pre>

<pre><code>1
</code></pre>

<p>We will convert our mask into numpy 2D array. We&rsquo;ll be later able to apply this matrix to mask our Netcdf file.</p>

<pre><code class="language-python">np.save('DATA/Mexico.npy',mask) # saving our mask in numpy.array
</code></pre>

<p>We will mask our area using .where() method.</p>

<pre><code class="language-python">ds_mask = ds_mean.where(mask == 1) 
ds_mask.to_netcdf('DATA/Mexico.nc')  # we want to save our shapefile mask in Netcdf format
</code></pre>

<pre><code class="language-python">ds_mask
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 145, longitude: 288)
Coordinates:
  * latitude   (latitude) float32 90.0 88.75 87.5 86.25 ... -87.5 -88.75 -90.0
  * longitude  (longitude) float32 0.0 1.25 2.5 3.75 ... 356.25 357.5 358.75
Data variables:
    t2m        (latitude, longitude) float32 nan nan nan nan ... nan nan nan nan
</code></pre>

<pre><code class="language-python">np.max(ds_mask.t2m)
</code></pre>

<pre><code>&lt;xarray.DataArray 't2m' ()&gt;
array(24.010315)
</code></pre>

<pre><code class="language-python">_, ax = make_figure()
# plot the temperature field
lat_bnd = [35, 0]
lon_bnd = [240, 280]
ds_mask.t2m.sel(longitude=slice(*lon_bnd), latitude=slice(*lat_bnd),).plot.pcolormesh(vmin=0, vmax=30, cmap='Spectral',add_colorbar=True, extend='both')
</code></pre>

<pre><code>&lt;matplotlib.collections.QuadMesh at 0xdc65400&gt;
</code></pre>

<p><img src="/img/netcdf/output_84_1.png" alt="png" /></p>

<h2 id="5-last-example-using-xarray">5- Last example using Xarray:</h2>

<p>In this section, We will calculate the seasonal accumulation of the precipitation, extract a region, plot the domain and record our result in Netcdf:</p>

<pre><code class="language-python"># Let's open cera20c_enda_ep_PR_*.nc netcdf files 
multi_dataDIR = './DATA/CERA20C/cera20c_enda_ep_PR_*.nc'
array = xr.open_mfdataset(multi_dataDIR)
array.tp
</code></pre>

<pre><code>&lt;xarray.DataArray 'tp' (time: 365, latitude: 181, longitude: 360)&gt;
dask.array&lt;shape=(365, 181, 360), dtype=float32, chunksize=(31, 181, 360)&gt;
Coordinates:
  * longitude  (longitude) float32 0.0 1.0 2.0 3.0 ... 356.0 357.0 358.0 359.0
  * latitude   (latitude) float32 90.0 89.0 88.0 87.0 ... -88.0 -89.0 -90.0
  * time       (time) datetime64[ns] 1971-01-02T18:00:00 ... 1972-01-01T18:00:00
Attributes:
    units:      m
    long_name:  Total precipitation
</code></pre>

<p>All Netcdf files are stored in DataArray container, we can now group our Datasets by season, apply a simple sum() method over time and then change units from meters to mm.</p>

<pre><code class="language-python">array_season = array.groupby('time.season').sum('time')*1000
array_season
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 181, longitude: 360, season: 4)
Coordinates:
  * latitude   (latitude) float32 90.0 89.0 88.0 87.0 ... -88.0 -89.0 -90.0
  * season     (season) object 'DJF' 'JJA' 'MAM' 'SON'
  * longitude  (longitude) float32 0.0 1.0 2.0 3.0 ... 356.0 357.0 358.0 359.0
Data variables:
    tp         (season, latitude, longitude) float32 dask.array&lt;shape=(4, 181, 360), chunksize=(1, 181, 360)&gt;
</code></pre>

<p>We want to extract a specific domain delimited:
    - latitude boundaries: 50N to 70N
    - longitude boudaries: 250E to 310E</p>

<p>We finally want to extract winter season.</p>

<pre><code class="language-python">lat_bnd = [70, 50]
lon_bnd = [250, 310]
subset_season_DJF = array_season.sel(season = 'DJF', longitude=slice(*lon_bnd), latitude=slice(*lat_bnd),)
subset_season_DJF
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 21, longitude: 61)
Coordinates:
  * latitude   (latitude) float32 70.0 69.0 68.0 67.0 ... 53.0 52.0 51.0 50.0
    season     &lt;U3 'DJF'
  * longitude  (longitude) float32 250.0 251.0 252.0 253.0 ... 308.0 309.0 310.0
Data variables:
    tp         (latitude, longitude) float32 dask.array&lt;shape=(21, 61), chunksize=(21, 61)&gt;
</code></pre>

<p>Let&rsquo;s save the Dataset to Netcdf.</p>

<pre><code class="language-python">dataDIR = './DATA/subset_season.nc'
subset_season_DJF.to_netcdf(dataDIR)
</code></pre>

<p>We can call our make_figure() function to quick plot our Dataset.</p>

<pre><code class="language-python">_, ax = make_figure()
# plot the temperature field
subset_season_DJF.tp.plot.pcolormesh(vmin=0, vmax=200, cmap='Spectral',add_colorbar=True, extend='both')
</code></pre>

<pre><code>&lt;matplotlib.collections.QuadMesh at 0x130aedd8&gt;
</code></pre>

<p><img src="/img/netcdf/output_94_1.png" alt="png" /></p>

<pre><code class="language-python">array_season
</code></pre>

<pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 181, longitude: 360, season: 4)
Coordinates:
  * latitude   (latitude) float32 90.0 89.0 88.0 87.0 ... -88.0 -89.0 -90.0
  * season     (season) object 'DJF' 'JJA' 'MAM' 'SON'
  * longitude  (longitude) float32 0.0 1.0 2.0 3.0 ... 356.0 357.0 358.0 359.0
Data variables:
    tp         (season, latitude, longitude) float32 dask.array&lt;shape=(4, 181, 360), chunksize=(1, 181, 360)&gt;
</code></pre>

          </div>

          



          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/courses/tutorial_python_netcdf/3-cartopy_library/" rel="next">3 Cartopy</a>
  </div>
  
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>Last updated on May 5, 2019</p>

          





  
  

<p class="edit-page">
  <a href="https://github.com/gcushen/hugo-academic/edit/master/content/courses/Tutorial_Python_Netcdf/4-Xarray_Library.md">
    <i class="fas fa-pen pr-2"></i>Edit this page
  </a>
</p>




          

        </div>

      </article>

      <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
  </p>
</footer>


    </main>
  </div>
</div>


      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js" integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js"></script>
        
      

      
      
    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.bcfae8267aba63cc55af53a503896bd9.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
